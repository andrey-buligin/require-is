define(["module","require","./is.api"],function(e,t,n){return n.features=e.config()||{},n.modules=null,n.lookup=function(e,r){if(n.features[e]!==undefined){r(n.features[e]);return}n.features[e]=!0,t([e]),r();return},n.load=function(e,t,r,i){if(!n.config){n.config=i;if(i.modules)for(var s=0;s<i.modules.length;s++)if(i.modules[s].layer===undefined){n.curModule=i.modules[s];break}}var o=n.deconstruct(e);o.type=="lookup"&&n.lookup(o.feature,r),(o.type=="load_if"||o.type=="load_if_not")&&n.lookup(o.feature,function(e){var i=[];n.config.isExclude&&(i=i.concat(n.config.isExclude)),n.curModule&&n.curModule.isExclude&&(i=i.concat(n.curModule.isExclude)),i.indexOf(o.feature)!=-1&&(o.type=="load_if"?o.yesModuleId=null:o.noModuleId=null),i.indexOf("~"+o.feature)!=-1&&(o.type=="load_if"?o.noModuleId=null:o.yesModuleId=null),t([o.yesModuleId,o.noModuleId],r)})},n.write=function(e,t,r){if(!n.writtenFeatureLayers){var i={};if(n.config.isLayers)for(var s in n.config.isLayers)n.features[s]&&(i[s]=n.config.isLayers[s]);if(n.curModule&&n.curModule.isLayers)for(var s in n.curModule.isLayers)n.features[s]&&(i[s]=n.curModule.isLayers[s]);var o="";for(var s in i)o||(o="require(['"+e+"'], function(is){ \n"),o+="is.on('"+s+"', function(complete) { require(['"+i[s]+"'], complete); }); \n";o&&(o+="});",r(o))}else n.writtenFeatureLayers=!0},n})